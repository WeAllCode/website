# Design Document

## Overview

This design outlines the migration from the deprecated Poetry buildpack to Heroku's native Python buildpack with uv support. The migration involves removing the deprecated buildpack, converting from Poetry to uv for dependency management, creating a `.python-version` file, and verifying the deployment works correctly with significantly improved performance.

Based on the current configuration analysis:

- Current Python version: 3.11.9 (specified in pyproject.toml and poetry.lock metadata)
- Poetry is currently used for dependency management
- No existing `.python-version` or `runtime.txt` files
- Django 5.2 application with PostgreSQL

## Architecture

### Current State

- Uses deprecated Poetry buildpack (likely `https://github.com/moneymeets/python-poetry-buildpack.git`)
- Poetry for dependency management with pyproject.toml and poetry.lock
- Dependencies exported to requirements.txt during build
- No explicit Python version specification for Heroku

### Target State

- Uses Heroku's native Python buildpack with uv support
- uv for fast dependency management and installation
- Explicit Python version specification via `.python-version`
- Significantly improved build performance and caching

## Components and Interfaces

### 1. Buildpack Configuration

**Current:** Custom Poetry buildpack in Heroku app settings
**Target:** Default Python buildpack with automatic uv detection

**Interface Changes:**

- Remove deprecated buildpack from Heroku configuration
- Rely on automatic Python buildpack detection
- Heroku automatically detects and uses uv when pyproject.toml is present

### 2. Python Version Specification

**Component:** `.python-version` file
**Purpose:** Explicitly specify Python 3.11.9 for Heroku builds
**Location:** Repository root
**Content:** Single line with Python version

### 3. Dependency Management Migration

**Current:** Poetry → requirements.txt → pip install
**Target:** uv direct installation from pyproject.toml

**Performance Benefits:**

- Significantly faster dependency resolution and installation
- Better caching mechanisms
- Parallel dependency installation
- Reduced build times (often 10-100x faster than pip)

### 4. Configuration Files

#### `.python-version`

```
3.11.9
```

#### `pyproject.toml` (Existing - Compatible with uv)

- Current Poetry configuration is compatible with uv
- No changes required to dependency specifications
- uv can read Poetry's pyproject.toml format directly

#### `uv.lock` (New - Generated by uv)

- Replaces poetry.lock
- More efficient lock file format
- Generated automatically by uv

## Data Models

### File Structure Changes

#### New Files

- `.python-version` - Python version specification
- `uv.lock` - uv lock file (replaces poetry.lock)

#### Modified Files

- `pyproject.toml` - May need minor adjustments for uv compatibility
- Remove any Poetry-specific configurations if needed
- `Dockerfile` - Update from Poetry to uv installation and dependency management
- `docker-compose.yml` - May need adjustments for uv workflow compatibility

#### Removed Files (Critical for uv precedence)

- `poetry.lock` - Replaced by uv.lock (must be removed for uv to take precedence)
- Any `requirements.txt` files - Must be removed to prevent pip from taking precedence
- Any `Pipfile` or `Pipfile.lock` - Must be removed to prevent pipenv from taking precedence

**Note:** Heroku uses package manager precedence for backwards compatibility. Other package manager files must be removed for uv to be used.

### Configuration Migration

#### pyproject.toml Compatibility

Current Poetry configuration in pyproject.toml is largely compatible with uv:

- `[tool.poetry.dependencies]` → uv reads this directly
- Python version constraint maintained
- Dependency specifications remain the same

#### Lock File Migration

- `poetry.lock` → `uv.lock`
- uv will generate new lock file from pyproject.toml
- More efficient format with faster parsing

## Error Handling

### Migration Risks and Mitigation

#### 1. Buildpack Removal Failure

**Risk:** Heroku CLI command fails or buildpack not found
**Mitigation:**

- Check current buildpacks with `heroku buildpacks` first
- Use exact buildpack URL/name from the list
- Verify removal with subsequent `heroku buildpacks` call

#### 2. uv Compatibility Issues

**Risk:** Some Poetry-specific configurations not supported by uv
**Mitigation:**

- Review pyproject.toml for Poetry-specific sections
- Test uv installation locally before deployment
- Keep Poetry configuration as backup during transition

#### 3. Dependency Resolution Differences

**Risk:** uv resolves dependencies differently than Poetry
**Mitigation:**

- Generate uv.lock locally and test thoroughly
- Compare resolved versions with poetry.lock
- Test all application functionality with new dependencies

#### 4. Heroku uv Support

**Risk:** Heroku buildpack doesn't properly detect or use uv
**Mitigation:**

- Verify Heroku Python buildpack supports uv
- Test deployment in staging environment
- Monitor build logs for uv usage confirmation

### Error Detection

#### Build-time Validation

- Heroku build logs should show uv being used for installation
- Significantly faster dependency installation times
- Python version should match .python-version specification

#### Runtime Validation

- Application should start successfully
- All Django functionality should work as before
- Database connections and static files should work correctly

## Testing Strategy

### Pre-Migration Testing

1. **Local uv Setup**

   - Install uv locally: `curl -LsSf https://astral.sh/uv/install.sh | sh`
   - Use `uv init` to create proper uv project structure (pyproject.toml, uv.lock, .python-version)
   - Migrate dependencies from Poetry format to uv-compatible format
   - Remove conflicting package manager files (poetry.lock, requirements.txt, Pipfile)
   - Test uv with migrated configuration: `uv sync`
   - Run application locally with uv-installed dependencies
   - Run full test suite with uv environment

2. **Dependency Comparison**
   - Compare uv.lock with poetry.lock for version differences
   - Test critical dependencies for compatibility
   - Verify no missing or conflicting dependencies

### Migration Testing

1. **Staging Environment**

   - Apply migration to staging environment first
   - Test full deployment process with uv
   - Verify application functionality
   - Compare build times (should be significantly faster)

2. **Build Process Validation**

   - Confirm uv is used for dependency installation
   - Verify Python 3.11.9 is used
   - Check for improved build performance
   - Validate uv.lock is generated correctly

3. **Functionality Testing**
   - Test all major application features
   - Verify database connectivity
   - Test static file serving
   - Validate email functionality
   - Test authentication flows
   - Test all Django management commands

### Post-Migration Monitoring

1. **Performance Metrics**

   - Monitor build times (expect significant improvement)
   - Track deployment success rates
   - Monitor application startup times

2. **Error Monitoring**
   - Watch for any new deployment errors
   - Monitor application error rates
   - Check for dependency-related issues

### Rollback Plan

If migration fails:

1. Re-add the deprecated Poetry buildpack
2. Remove .python-version and uv.lock files
3. Restore poetry.lock file
4. Redeploy with previous Poetry configuration
5. Investigate issues before retry

### Success Criteria

- Successful deployment to Heroku using uv
- All application functionality works as before
- Build logs show uv being used for dependency installation
- Significantly improved build times (target: 50%+ faster)
- No increase in application errors
- uv.lock file generated and used correctly

## Performance Expectations

### Build Time Improvements

- **Dependency Resolution:** 10-100x faster than Poetry
- **Installation:** 2-10x faster than pip
- **Overall Build:** Expected 50-80% reduction in build time
- **Caching:** More efficient caching of dependencies

### Resource Usage

- Lower memory usage during dependency resolution
- Faster cold starts due to efficient dependency installation
- Better utilization of Heroku build resources
